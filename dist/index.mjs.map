{"version":3,"file":"index.mjs","sources":["../src/index.js"],"sourcesContent":["'use strict'\n\nimport teme from 'teme'\n\n//\n// Field state.\n//\n// Has two inputs sreams of data\n//\n// - value (from backend)\n// - text (from user)\n//\n// goes through\n// - validation (of input)\n// - parsing (of input)\n// - formatting (of value)\n//\n// and produces output stream of\n// - value (to backend)\n// - text (to user)\n// - error (to user)\n//\nexport class FieldState {\n  constructor (opts = {}) {\n    this.validator = ensureArray(opts.validator || [])\n    this.parser = opts.parser\n    this.formatter = opts.formatter\n    // the two input streams\n    this.value = teme()\n    this.text = teme()\n\n    this.value.subscribe(v => this._updateValue(v))\n    this.text.subscribe(t => this._updateText(t))\n    this.update = teme()\n    this.state = this.update.scan((s, p) => Object.assign({}, s, p), {})\n    this.value(opts.value)\n  }\n\n  _updateValue (value) {\n    // new value supplied, so format text accordingly\n    const text = format(value, this.formatter)\n    this.update({ error: '', value, text, dirty: false })\n  }\n\n  _updateText (text) {\n    // new text value supplied, so add it, and queue validation\n    this.update({ text, dirty: true })\n    Promise.resolve().then(() => this.validate())\n  }\n\n  // can be called by user - async validate and updates status\n  // message\n  //\n  // returns true if valid\n  async validate () {\n    let error = ''\n    let text = this.state().text || ''\n    for (let i = 0; i < this.validator.length; i++) {\n      const validator = this.validator[i]\n      const result = await validator(text)\n      if (result) {\n        error = result\n        break\n      }\n    }\n    if (!error) {\n      const value = parse(text, this.parser)\n      text = format(value, this.formatter)\n      this.update({ error, value, text })\n      return true\n    } else {\n      this.update({ error, text })\n      return false\n    }\n  }\n}\n\nexport class FormState {\n  constructor (fields = {}) {\n    this.fields = fields\n    this.state = teme\n      .combine(\n        () => this._updateState(),\n        Object.values(fields).map(f => f.state)\n      )\n      .dedupe(shallow)\n  }\n\n  _updateState () {\n    return Object.values(this.fields).reduce(\n      ({ error, dirty }, fld) => ({\n        error: error || fld.state().error,\n        dirty: dirty || fld.state().dirty\n      }),\n      { error: '', dirty: false }\n    )\n  }\n\n  validate () {\n    // force validation of each field, return true if all valid\n    return Promise.all(\n      Object.values(this.fields).map(fld => fld.validate())\n    ).then(valids => valids.every(Boolean))\n  }\n\n  set (data) {\n    Object.entries(this.fields).forEach(([k, fld]) => fld.value(data[k]))\n  }\n\n  getChanges () {\n    return Object.entries(this.fields).reduce((o, [k, fld]) => {\n      const { dirty, value } = fld.state()\n      if (dirty) o[k] = value\n      return o\n    }, {})\n  }\n\n  getValues () {\n    return Object.entries(this.fields).reduce((o, [k, fld]) => {\n      o[k] = fld.state().value\n      return o\n    }, {})\n  }\n}\n\nfunction format (value, formatter) {\n  if (formatter) return formatter(value)\n  if (value == null) return ''\n  return String(value)\n}\n\nfunction parse (text, parser) {\n  return parser ? parser(text) : text\n}\n\nfunction ensureArray (o) {\n  return Array.isArray(o) ? o : [o]\n}\n\nfunction shallow (a, b) {\n  return (\n    a === b ||\n    (a &&\n      b &&\n      typeof a === 'object' &&\n      typeof b === 'object' &&\n      Object.keys(b).every(k => Object.prototype.hasOwnProperty.call(a, k)) &&\n      Object.keys(a).every(k => b[k] === a[k]))\n  )\n}\n"],"names":[],"mappings":"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"}